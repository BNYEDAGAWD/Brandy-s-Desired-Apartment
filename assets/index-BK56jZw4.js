!function(){const e=document.createElement("link").relList;if(!(e&&e.supports&&e.supports("modulepreload"))){for(const e of document.querySelectorAll('link[rel="modulepreload"]'))t(e);new MutationObserver(e=>{for(const a of e)if("childList"===a.type)for(const e of a.addedNodes)"LINK"===e.tagName&&"modulepreload"===e.rel&&t(e)}).observe(document,{childList:!0,subtree:!0})}function t(e){if(e.ep)return;e.ep=!0;const t=function(e){const t={};return e.integrity&&(t.integrity=e.integrity),e.referrerPolicy&&(t.referrerPolicy=e.referrerPolicy),"use-credentials"===e.crossOrigin?t.credentials="include":"anonymous"===e.crossOrigin?t.credentials="omit":t.credentials="same-origin",t}(e);fetch(e.href,t)}}();class e{constructor(){this.baseUrl=this.detectBackendUrl(),this.isBackendAvailable=!1,this.lastHealthCheck=null}detectBackendUrl(){"localhost"===window.location.hostname||window.location.hostname;return"http://localhost:8000"}async checkHealth(){if(!this.baseUrl)return{available:!1,reason:"Backend URL not configured"};try{const e=new AbortController,t=setTimeout(()=>e.abort(),5e3),a=await fetch(`${this.baseUrl}/health`,{method:"GET",headers:{"Content-Type":"application/json"},signal:e.signal});if(clearTimeout(t),a.ok){const e=await a.json();return this.isBackendAvailable=e.agent_ready,this.lastHealthCheck=new Date,{available:this.isBackendAvailable,health:e}}return{available:!1,reason:`HTTP ${a.status}`}}catch(e){return this.isBackendAvailable=!1,{available:!1,reason:"AbortError"===e.name?"Timeout":e.message}}}async searchApartments(e=null,t={}){const a=await this.checkHealth();if(!a.available)throw new Error(`DeepSearchAgent backend not available: ${a.reason}`);try{const a={zip_codes:e||["90066","90230","90232","90034"],max_results:t.maxResults||50,filters:{min_price:t.minPrice||4400,max_price:t.maxPrice||5200,min_score:t.minScore||75,required_amenities:t.requiredAmenities||["In-unit washer/dryer","Air conditioning","Outdoor space (balcony/patio/terrace)","Above ground floor"]},geo_params:{location:"Los Angeles, CA",dma_code:"los-angeles-dma",radius:"25mi",region:"us-west"},search_params:{freshness:"week",sort:"relevance",dedup:!0}};console.log("🔍 Sending LA DMA optimized search request to DeepSearchAgent:",a);const r=new AbortController,s=setTimeout(()=>r.abort(),9e4),i=await fetch(`${this.baseUrl}/search`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(a),signal:r.signal});if(clearTimeout(s),!i.ok){const e=await i.json().catch(()=>({}));throw new Error(e.detail||`Search failed with status ${i.status}`)}const n=await i.json();return console.log("✅ DeepSearchAgent search completed:",n),this.transformSearchResults(n)}catch(r){throw console.error("❌ DeepSearchAgent search failed:",r),r}}async verifyListing(e){const t=await this.checkHealth();if(!t.available)throw new Error(`DeepSearchAgent backend not available: ${t.reason}`);try{const t=new AbortController,a=setTimeout(()=>t.abort(),3e4),r=await fetch(`${this.baseUrl}/verify-listing`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({listing_url:e}),signal:t.signal});if(clearTimeout(a),!r.ok)throw new Error(`Verification failed with status ${r.status}`);return await r.json()}catch(a){throw console.error("❌ Listing verification failed:",a),a}}async getSearchConfig(){if(!(await this.checkHealth()).available)return null;try{const e=await fetch(`${this.baseUrl}/config`);if(e.ok)return await e.json()}catch(e){console.warn("Could not fetch search config:",e)}return null}transformSearchResults(e){return e.success&&e.apartments?e.apartments.map(e=>this.transformApartment(e)):[]}transformApartment(e){return{id:e.id||this.generateId(e),title:e.title||this.generateTitle(e),address:e.address||"Address not available",zipCode:e.zip_code||e.zipCode||"Unknown",price:e.price||0,bedrooms:e.bedrooms||2,bathrooms:e.bathrooms||1.5,sqft:e.sqft||null,floor:e.floor||null,features:this.transformAmenities(e.amenities||[]),highlightFeatures:this.getHighlightFeatures(e.amenities||[]),recentlyRenovated:this.hasAmenity(e.amenities,"recently_renovated"),premiumAmenities:this.hasPremiumAmenities(e.amenities||[]),datePosted:e.datePosted||e.found_at||(new Date).toISOString(),source:e.platform||e.source||"DeepSearch",url:e.url||e.source_url,contact:e.contact||{},images:e.images||[],description:e.description||this.generateDescription(e),score:this.calculateDisplayScore(e),scoreBreakdown:e.validation||{},urlHealth:this.transformUrlHealth(e),urlHealthSummary:this.generateUrlHealthSummary(e),backupUrls:e.backup_urls||[],searchMetadata:e.search_metadata||{},extractedAt:e.extracted_at||(new Date).toISOString()}}generateId(e){return`apt_${[e.address||"",e.price||"",e.bedrooms||"",Date.now()].join("_").replace(/[^a-zA-Z0-9_]/g,"_")}`}generateTitle(e){return`${e.bedrooms||2}-Bedroom Apartment in ${this.extractAreaFromAddress(e.address)||"West LA"}`}extractAreaFromAddress(e){if(!e)return null;const t=["Mar Vista","Culver City","Palms","Venice","Santa Monica"];for(const a of t)if(e.toLowerCase().includes(a.toLowerCase()))return a;return null}transformAmenities(e){const t={washer_dryer:"In-Unit Washer/Dryer",washer_dryer_in_unit:"In-Unit Washer/Dryer",air_conditioning:"Central Air Conditioning",outdoor_space:"Private Balcony/Patio",above_ground_floor:"Above Ground Floor",renovated:"Recently Renovated",natural_light:"Ample Natural Light",parking:"Parking Included",pool:"Swimming Pool",gym:"Fitness Center",dishwasher:"Dishwasher",hardwood:"Hardwood Floors",granite:"Granite Countertops",stainless:"Stainless Steel Appliances"};return e.map(e=>t[e]||this.capitalizeAmenity(e))}capitalizeAmenity(e){return e.replace(/_/g," ").split(" ").map(e=>e.charAt(0).toUpperCase()+e.slice(1)).join(" ")}getHighlightFeatures(e){const t=["washer_dryer","washer_dryer_in_unit","air_conditioning","outdoor_space","above_ground_floor","renovated","recently_renovated","natural_light","hardwood","granite"];return e.filter(e=>t.includes(e)).map(e=>this.transformAmenities([e])[0])}hasAmenity(e,t){return e&&e.includes(t)}hasPremiumAmenities(e){return["pool","gym","parking","granite","stainless"].some(t=>e.includes(t))}generateDescription(e){return`Beautiful ${e.bedrooms||2}-bedroom apartment in ${this.extractAreaFromAddress(e.address)||"West LA"}. Rent: ${e.price?`$${e.price.toLocaleString()}`:"Contact for pricing"}/month. Verified listing found through DeepSearch AI. Contact directly for viewing and more information.`}calculateDisplayScore(e){const t=e.validation;if(t&&t.percentage)return Math.round(t.percentage);let a=50;const r=e.price||0;r>=4400&&r<=5200?a+=25:r>=4e3&&r<=5500&&(a+=15);const s=e.amenities||[];(s.includes("washer_dryer")||s.includes("washer_dryer_in_unit"))&&(a+=10),s.includes("air_conditioning")&&(a+=10),s.includes("outdoor_space")&&(a+=10),s.includes("above_ground_floor")&&(a+=10),(s.includes("renovated")||s.includes("recently_renovated"))&&(a+=5),s.includes("natural_light")&&(a+=5),this.hasPremiumAmenities(s)&&(a+=5);return a+={90066:10,90230:7,90232:5,90034:3}[e.zip_code||e.zipCode]||0,Math.min(100,Math.max(0,a))}transformUrlHealth(e){const t=e.verification;return t?{healthy:t.verified,status:t.verified?"verified":"failed",error:t.error,responseTime:t.response_time,verifiedAt:t.verified_at}:{healthy:!0,status:"unverified"}}generateUrlHealthSummary(e){return this.transformUrlHealth(e).healthy?{className:"healthy",icon:"fas fa-check-circle",message:"Link verified and accessible"}:{className:"error",icon:"fas fa-exclamation-triangle",message:"Primary link may not work - see alternatives"}}static async isAvailable(){const t=new e;return(await t.checkHealth()).available}getBackendStatus(){return{baseUrl:this.baseUrl,isAvailable:this.isBackendAvailable,lastHealthCheck:this.lastHealthCheck}}}class t{constructor(){this.searchCriteria={rentRange:"$4,400 - $5,200/month",minRent:4400,maxRent:5200,bedrooms:2,minBathrooms:1.5,maxBathrooms:2,zipCodes:["90066","90230","90232","90034"],zipCodePriority:{90066:1,90230:2,90232:3,90034:4},targetZipCodes:{90066:"Mar Vista (Priority 1)",90230:"Central Culver City (Priority 2)",90232:"Southeast Culver City (Priority 3)",90034:"Palms (Priority 4)"},requiredAmenities:["In-unit washer/dryer","Air conditioning","Outdoor space (balcony/patio/terrace)","Above ground floor"],preferredFeatures:["Recently renovated (within 10 years)","Modern/contemporary interior","Ample natural light"],laDmaConfig:{market:"los-angeles-dma",region:"us-west",locale:"en-US",radius:"25mi"}},this.deepSearchClient=new e,this.isDeepSearchAvailable=!1}async searchApartments(e){console.log("🏠 Starting live apartment search with DeepSearchAgent...");const t=await this.deepSearchClient.checkHealth();if(this.isDeepSearchAvailable=t.available,e&&e(10),!this.isDeepSearchAvailable)throw console.warn("⚠️ DeepSearchAgent not available:",t.reason),new Error(`DeepSearchAgent backend not available: ${t.reason}. Please start the backend server.`);try{e&&e(25);const t={minPrice:this.searchCriteria.minRent,maxPrice:this.searchCriteria.maxRent,maxResults:50,requiredAmenities:this.searchCriteria.requiredAmenities};console.log("🔍 Searching with DeepSearchAgent...",{zipCodes:this.searchCriteria.zipCodes,filters:t}),e&&e(50);const a=await this.deepSearchClient.searchApartments(this.searchCriteria.zipCodes,t);console.log(`✅ DeepSearchAgent found ${a.length} live apartments`),e&&e(75);const r=a.filter(e=>this.validateApartment(e));console.log(`✅ ${r.length} live apartments passed validation`);const s=this.sortApartmentsByPriority(r);return e&&e(100),this.logSearchSummary(s),s}catch(a){throw console.error("❌ DeepSearchAgent search failed:",a),new Error(`DeepSearchAgent search failed: ${a.message}. Please check backend configuration.`)}}validateApartment(e){const t=this.searchCriteria;return e.title&&e.address&&e.url?e.price<t.minRent||e.price>t.maxRent?(console.log(`❌ Apartment rejected - price ${e.price} outside range`),!1):e.bedrooms!==t.bedrooms?(console.log(`❌ Apartment rejected - ${e.bedrooms} bedrooms, need ${t.bedrooms}`),!1):e.bathrooms<t.minBathrooms||e.bathrooms>t.maxBathrooms?(console.log(`❌ Apartment rejected - ${e.bathrooms} bathrooms outside range`),!1):e.url&&""!==e.url.trim()?(console.log(`✅ Live apartment validated: ${e.title}`),!0):(console.log("❌ Apartment rejected - no valid URL"),!1):(console.log("❌ Apartment rejected - missing required fields"),!1)}sortApartmentsByPriority(e){return e.sort((e,t)=>{const a=this.searchCriteria.zipCodePriority[e.zipCode]||999,r=this.searchCriteria.zipCodePriority[t.zipCode]||999;return a!==r?a-r:(t.score||0)-(e.score||0)})}logSearchSummary(e){console.log("\n📊 LIVE SEARCH SUMMARY:"),console.log(`Total live apartments found: ${e.length}`);const t=e.reduce((e,t)=>(e[t.zipCode]=(e[t.zipCode]||0)+1,e),{});console.log("Breakdown by zip code:"),Object.entries(t).forEach(([e,t])=>{const a=this.getAreaName(e);console.log(`  ${e} (${a}): ${t} live apartments`)});const a=e.reduce((e,t)=>(e[t.source]=(e[t.source]||0)+1,e),{});console.log("Data sources:"),Object.entries(a).forEach(([e,t])=>{console.log(`  ${e}: ${t} listings`)});const r=e.map(e=>e.price).filter(e=>e>0);if(r.length>0){const e=Math.min(...r),t=Math.max(...r),a=Math.round(r.reduce((e,t)=>e+t,0)/r.length);console.log(`Price range: $${e.toLocaleString()} - $${t.toLocaleString()} (avg: $${a.toLocaleString()})`)}const s=e.map(e=>e.score).filter(e=>e>0);if(s.length>0){const e=Math.round(s.reduce((e,t)=>e+t,0)/s.length),t=Math.max(...s);console.log(`Score range: ${Math.min(...s)} - ${t} (avg: ${e})`)}console.log("\n🎯 Top 5 live matches:"),e.slice(0,5).forEach((e,t)=>{console.log(`${t+1}. ${e.title} - ${e.address} - $${e.price} (Score: ${e.score}) [${e.source}]`)})}getAreaName(e){return{90066:"Mar Vista",90230:"Culver City",90232:"Culver City",90034:"Palms"}[e]||"West LA"}getStatus(){return{type:"live",deepSearchAvailable:this.isDeepSearchAvailable,backendStatus:this.deepSearchClient.getBackendStatus(),searchCriteria:this.searchCriteria,message:"Live apartment search powered by DeepSearchAgent"}}delay(e){return new Promise(t=>setTimeout(t,e))}}class a{constructor(){this.weights={rentInRange:20,mandatoryAmenities:30,renovationRecency:25,naturalLight:15,outdoorSpaceQuality:10,zipCodePriority:10,premiumAmenities:5,locationRating:5,professionalPhotos:3,floorLevel:2},this.maxScore=100}calculateScore(e,t={minRent:4400,maxRent:5200,zipCodePriority:{90066:1,90230:2,90232:3,90034:4}}){let a=0;a+=this.calculateRentScore(e.price,t);a+=this.calculateMandatoryAmenityScore(e);a+=this.calculateRenovationScore(e);a+=this.calculateNaturalLightScore(e);a+=this.calculateOutdoorSpaceScore(e);a+=this.calculateZipCodeScore(e.zipCode,t);a+=this.calculatePremiumAmenitiesScore(e);a+=this.calculateLocationRatingScore(e);a+=this.calculatePhotoScore(e);return a+=this.calculateFloorScore(e),Math.round(Math.min(a,this.maxScore))}getScoreBreakdown(e,t={minRent:4400,maxRent:5200,zipCodePriority:{90066:1,90230:2,90232:3,90034:4}}){const a={};return a.price=this.calculateRentScore(e.price,t),a.specs=this.calculateMandatoryAmenityScore(e),a.floor=this.calculateFloorScore(e),a.features=this.calculateRenovationScore(e)+this.calculateNaturalLightScore(e)+this.calculateOutdoorSpaceScore(e),a.renovation=e.recentlyRenovated?10:0,a.total=Math.min(a.price+a.specs+a.floor+a.features+a.renovation,100),a}calculateRentScore(e,t){const{minRent:a,maxRent:r}=t;if(e<a||e>r)return 0;const s=(a+r)/2,i=(r-a)/2,n=Math.abs(e-s),o=this.weights.rentInRange*(1-n/i);return Math.round(o)}calculateMandatoryAmenityScore(e){const t={washerDryer:!1,airConditioning:!1,outdoorSpace:!1,aboveGroundFloor:!1},a=e.features.map(e=>e.toLowerCase());t.washerDryer=a.some(e=>e.includes("washer")&&e.includes("dryer")||e.includes("w/d")||e.includes("laundry")),t.airConditioning=a.some(e=>e.includes("air")||e.includes("conditioning")||e.includes("hvac")||e.includes("central air")),t.outdoorSpace=a.some(e=>e.includes("balcony")||e.includes("patio")||e.includes("terrace")||e.includes("deck")||e.includes("outdoor")),t.aboveGroundFloor=e.floor>1;const r=Object.values(t).filter(Boolean).length/Object.keys(t).length;return Math.round(this.weights.mandatoryAmenities*r)}calculateRenovationScore(e){const t=e.features.map(e=>e.toLowerCase()),a=["renovated","updated","remodeled","modern","new","contemporary","upgraded","refreshed","redesigned"],r=t.some(e=>a.some(t=>e.includes(t))),s=e.recentlyRenovated||!1,i=["stainless steel","granite","quartz","hardwood","modern kitchen","designer","luxury"],n=t.some(e=>i.some(t=>e.includes(t)));let o=0;return o=s?this.weights.renovationRecency:r&&n?.8*this.weights.renovationRecency:r||n?.5*this.weights.renovationRecency:.2*this.weights.renovationRecency,Math.round(o)}calculateNaturalLightScore(e){const t=e.features.map(e=>e.toLowerCase()),a=e.description?.toLowerCase()||"",r=["natural light","bright","sunny","light-filled","windows","large windows","floor-to-ceiling","multiple exposures","corner unit"],s=t.concat([a]).some(e=>r.some(t=>e.includes(t))),i=e.floor>5?.2:0;let n=0;return n=s?this.weights.naturalLight*(.8+i):this.weights.naturalLight*(.4+i),Math.round(n)}calculateOutdoorSpaceScore(e){const t=e.features.map(e=>e.toLowerCase()),a={"private balcony":1,terrace:1,"private patio":.9,deck:.8,balcony:.7,patio:.6,outdoor:.5};let r=0;for(const[s,i]of Object.entries(a))t.some(e=>e.includes(s))&&(r=Math.max(r,this.weights.outdoorSpaceQuality*i));return Math.round(r)}calculateZipCodeScore(e,t){const a=t.zipCodePriority[e]||5,r=Math.max(0,(5-a)/4);return Math.round(this.weights.zipCodePriority*r)}calculatePremiumAmenitiesScore(e){const t=e.features.map(e=>e.toLowerCase()),a=["swimming pool","fitness center","gym","concierge","doorman","roof deck","rooftop","parking garage","valet parking","business center","club room"],r=t.filter(e=>a.some(t=>e.includes(t))).length,s=Math.min(1.5*r,this.weights.premiumAmenities);return Math.round(s)}calculateLocationRatingScore(e){const t={90066:4.5,90230:4.2,90232:3.8,90034:3.5}[e.zipCode]||3,a=e.price>4800?.2:0,r=Math.min(t+a,5),s=Math.max(0,(r-3)/2);return Math.round(this.weights.locationRating*s)}calculatePhotoScore(e){const t=e.images?.length||0;return t>=5?this.weights.professionalPhotos:t>=3?Math.round(.7*this.weights.professionalPhotos):t>=1?Math.round(.4*this.weights.professionalPhotos):0}calculateFloorScore(e){const t=e.floor||2;return t>=3&&t<=6?this.weights.floorLevel:2===t||7===t||8===t?Math.round(.7*this.weights.floorLevel):t>8?Math.round(.5*this.weights.floorLevel):0}}const r=new class{constructor(e={}){this.options={rootMargin:"50px",threshold:.1,placeholderSrc:"data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48ZGVmcz48bGluZWFyR3JhZGllbnQgaWQ9ImciIHgxPSIwJSIgeTE9IjAlIiB4Mj0iMTAwJSIgeTI9IjEwMCUiPjxzdG9wIG9mZnNldD0iMCUiIHN0b3AtY29sb3I9IiNmNWY1ZjUiLz48c3RvcCBvZmZzZXQ9IjEwMCUiIHN0b3AtY29sb3I9IiNlZWVlZWUiLz48L2xpbmVhckdyYWRpZW50PjwvZGVmcz48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJ1cmwoI2cpIi8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCwgc2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNHB4IiBmaWxsPSIjOTk5OTk5IiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBkb21pbmFudC1iYXNlbGluZT0ibWlkZGxlIj5Mb2FkaW5nLi4uPC90ZXh0Pjwvc3ZnPg==",errorSrc:"data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZjVmNWY1Ii8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCwgc2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNHB4IiBmaWxsPSIjOTk5OTk5IiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBkb21pbmFudC1iYXNlbGluZT0ibWlkZGxlIj5JbWFnZSBVbmF2YWlsYWJsZTwvdGV4dD48L3N2Zz4=",fadeInDuration:300,retryAttempts:2,retryDelay:1e3,...e},this.observer=null,this.loadedImages=new Set,this.failedImages=new Set,this.retryCount=new Map,this.init()}init(){"IntersectionObserver"in window?(this.observer=new IntersectionObserver(e=>{e.forEach(e=>{e.isIntersecting&&this.loadImage(e.target)})},{rootMargin:this.options.rootMargin,threshold:this.options.threshold}),this.observeImages()):this.loadAllImages()}observeImages(){document.querySelectorAll("img[data-src]").forEach(e=>{this.loadedImages.has(e)||(this.setupImageForLazyLoading(e),this.observer.observe(e))})}setupImageForLazyLoading(e){e.src&&""!==e.src||(e.src=this.options.placeholderSrc),e.classList.add("lazy-loading"),this.addLoadingIndicator(e),e.style.opacity="0",e.style.transition=`opacity ${this.options.fadeInDuration}ms ease-in-out`}addLoadingIndicator(e){const t=e.parentElement;if(!t.classList.contains("image-container")){const t=document.createElement("div");t.className="image-container",e.parentNode.insertBefore(t,e),t.appendChild(e)}if(!t.querySelector(".loading-indicator")){const e=document.createElement("div");e.className="loading-indicator",e.innerHTML='\n                <div class="loading-spinner">\n                    <div class="spinner"></div>\n                </div>\n            ',t.appendChild(e)}}async loadImage(e){const t=e.getAttribute("data-src");if(t&&!this.loadedImages.has(e))try{this.observer&&this.observer.unobserve(e),await this.preloadImage(t),e.src=t,e.removeAttribute("data-src"),e.classList.remove("lazy-loading"),e.classList.add("lazy-loaded"),e.style.opacity="1",this.removeLoadingIndicator(e),this.loadedImages.add(e),e.dispatchEvent(new CustomEvent("lazyLoaded",{detail:{src:t,img:e}}))}catch(a){console.warn("Failed to load image:",t,a),await this.handleImageError(e,t)}}preloadImage(e){return new Promise((t,a)=>{const r=new Image;r.onload=()=>t(r),r.onerror=()=>a(new Error(`Failed to load image: ${e}`)),setTimeout(()=>{a(new Error(`Image load timeout: ${e}`))},1e4),r.src=e})}async handleImageError(e,t){const a=t,r=this.retryCount.get(a)||0;if(r<this.options.retryAttempts){this.retryCount.set(a,r+1),await new Promise(e=>setTimeout(e,this.options.retryDelay));try{return await this.preloadImage(t),e.src=t,e.removeAttribute("data-src"),e.classList.remove("lazy-loading"),e.classList.add("lazy-loaded"),e.style.opacity="1",this.removeLoadingIndicator(e),void this.loadedImages.add(e)}catch{console.warn(`Retry ${r+1} failed for image:`,t)}}e.src=this.options.errorSrc,e.classList.remove("lazy-loading"),e.classList.add("lazy-error"),e.style.opacity="1",this.removeLoadingIndicator(e),this.failedImages.add(e),e.dispatchEvent(new CustomEvent("lazyLoadError",{detail:{originalSrc:t,img:e}}))}removeLoadingIndicator(e){const t=e.parentElement.querySelector(".loading-indicator");t&&(t.classList.add("fade-out"),setTimeout(()=>{t.parentNode&&t.parentNode.removeChild(t)},200))}loadAllImages(){document.querySelectorAll("img[data-src]").forEach(e=>{this.setupImageForLazyLoading(e),this.loadImage(e)})}refresh(){this.observer&&this.observeImages()}observe(e){if(!this.observer)return;(Array.isArray(e)?e:[e]).forEach(e=>{"IMG"===e.tagName&&e.hasAttribute("data-src")&&(this.setupImageForLazyLoading(e),this.observer.observe(e))})}loadImagesInContainer(e){e.querySelectorAll("img[data-src]").forEach(e=>this.loadImage(e))}getStats(){return{loaded:this.loadedImages.size,failed:this.failedImages.size,pending:document.querySelectorAll("img[data-src]").length}}destroy(){this.observer&&(this.observer.disconnect(),this.observer=null),this.loadedImages.clear(),this.failedImages.clear(),this.retryCount.clear()}};"undefined"!=typeof window&&("loading"===document.readyState?document.addEventListener("DOMContentLoaded",()=>{r.refresh()}):r.refresh());class s{constructor(){this.verificationCache=new Map,this.confidenceThreshold=.75,this.maxCacheAge=9e5,this.addressPatterns=this.initializeAddressPatterns(),this.providerPatterns=this.initializeProviderPatterns(),this.imageHashes=new Map,this.restrictionHandlers=this.initializeRestrictionHandlers()}initializeAddressPatterns(){return{streetNumber:/^(\d+[a-z]?)\s+/i,streetName:/\d+[a-z]?\s+([^,]+?)(?:\s+(?:ave|avenue|st|street|blvd|boulevard|dr|drive|rd|road|way|pl|place|ct|court|circle|cir|lane|ln)\.?)?(?:\s*,|\s*$)/i,zipCode:/(90066|90230|90232|90034)/,neighborhood:/(mar vista|culver city|palms|venice|santa monica|west la|westside)/i,unitDesignators:/(apt|apartment|unit|suite|#)\s*([a-z0-9]+)/i,coordinates:/(-?\d{2,3}\.\d+),\s*(-?\d{2,3}\.\d+)/}}initializeProviderPatterns(){return{"apartments.com":{urlPattern:/apartments\.com\/.*\/(\d+)/,listingIdExtractor:/apartments\.com\/.*\/(\d+)/,priceSelector:/\$[\d,]+/,bedroomSelector:/(\d+)\s*(?:bed|br|bedroom)/i,addressSelector:/(\d+[^,]+,\s*[^,]+,\s*CA\s*\d{5})/i},"zillow.com":{urlPattern:/zillow\.com\/.*\/(\d+)_zpid/,listingIdExtractor:/(\d+)_zpid/,priceSelector:/\$[\d,]+\/mo/,bedroomSelector:/(\d+)\s*bd/i,addressSelector:/(\d+[^,]+,\s*[^,]+,\s*CA)/i},"trulia.com":{urlPattern:/trulia\.com\/.*\/(\d+)/,listingIdExtractor:/trulia\.com\/.*\/(\d+)/,priceSelector:/\$[\d,]+/,bedroomSelector:/(\d+)\s*bed/i,addressSelector:/(\d+[^,]+,\s*[^,]+,\s*CA)/i},"hotpads.com":{urlPattern:/hotpads\.com\/.*\/(\d+)/,listingIdExtractor:/hotpads\.com\/.*\/(\d+)/,priceSelector:/\$[\d,]+/,bedroomSelector:/(\d+)\s*bed/i,addressSelector:/(\d+[^,]+)/i},"westsiderentals.com":{urlPattern:/westsiderentals\.com\/.*id=(\d+)/,listingIdExtractor:/id=(\d+)/,priceSelector:/\$[\d,]+/,bedroomSelector:/(\d+)\s*bedroom/i,addressSelector:/(\d+[^,]+,\s*[^,]+)/i}}}initializeRestrictionHandlers(){return{cors:{fallbackMethods:["proxy","inference","pattern"],confidence:.6},csp:{fallbackMethods:["inference","pattern"],confidence:.5},rate_limit:{fallbackMethods:["cache","delay","inference"],confidence:.7}}}async verifyListingCorrelation(e,t){const a=`${e.id||"unknown"}_${this.hashUrl(t)}`,r=this.getFromCache(a);if(r)return r;const s={timestamp:Date.now(),targetUrl:t,listing:{id:e.id,title:e.title,address:e.address,price:e.price},verification:{address:null,property:null,provider:null,visual:null,overall:null},confidence:{address:0,property:0,provider:0,visual:0,overall:0},restrictionHandling:{detected:[],strategies:[],successful:!1}};try{const[r,n,o]=await Promise.allSettled([this.verifyAddressCorrelation(e,t),this.verifyPropertyDetails(e,t),this.verifyProviderAuthenticity(e,t)]);"fulfilled"===r.status&&(s.verification.address=r.value,s.confidence.address=r.value.confidence),"fulfilled"===n.status&&(s.verification.property=n.value,s.confidence.property=n.value.confidence),"fulfilled"===o.status&&(s.verification.provider=o.value,s.confidence.provider=o.value.confidence);try{const a=await this.verifyVisualAssets(e,t);s.verification.visual=a,s.confidence.visual=a.confidence}catch(i){s.verification.visual={status:"restricted",reason:"browser_limitation"},s.confidence.visual=.3}if(s.confidence.overall=this.calculateOverallConfidence(s.confidence),s.verification.overall=this.generateOverallVerification(s),s.confidence.overall<this.confidenceThreshold){const a=await this.applyRestrictionHandling(s,e,t);Object.assign(s,a)}return this.setCache(a,s),s}catch(i){const r=await this.generateInferredVerification(e,t,i);return this.setCache(a,r),r}}async verifyAddressCorrelation(e,t){const a={status:"pending",matches:{},confidence:0,details:{}};try{const r=this.parseAddress(e.address||""),s=this.extractAddressFromUrl(t);let i=null;try{i=await this.extractAddressFromMetadata(t)}catch{i=this.inferAddressFromUrlPatterns(t)}const n=this.compareStreetAddresses(r.street,s.street,i?.street),o=this.compareZipCodes(r.zipCode,s.zipCode,i?.zipCode),c=this.compareNeighborhoods(r.neighborhood,s.neighborhood,i?.neighborhood);return a.matches={street:n,zipCode:o,neighborhood:c},a.confidence=this.calculateAddressConfidence(a.matches),a.status=a.confidence>.7?"verified":a.confidence>.4?"partial":"failed",a.details={listingAddress:r,urlAddress:s,metadataAddress:i||"restricted",confidenceFactors:{streetWeight:.5,zipWeight:.3,neighborhoodWeight:.2}},a}catch(r){return this.inferAddressVerification(e,t,r)}}async verifyPropertyDetails(e,t){const a={status:"pending",matches:{},confidence:0,details:{}};try{const r=await this.extractPropertyDetailsFromUrl(t),s=this.comparePrices(e.price,r.price),i=this.compareBedrooms(e.bedrooms,r.bedrooms),n=this.compareBathrooms(e.bathrooms,r.bathrooms),o=this.compareAmenities(e.amenities||[],r.amenities||[]);return a.matches={price:s,bedrooms:i,bathrooms:n,amenities:o},a.confidence=this.calculatePropertyConfidence(a.matches),a.status=a.confidence>.8?"verified":a.confidence>.5?"partial":"failed",a.details={listingDetails:{price:e.price,bedrooms:e.bedrooms,bathrooms:e.bathrooms,amenities:e.amenities},urlDetails:r,confidenceWeights:{price:.3,bedrooms:.25,bathrooms:.15,amenities:.3}},a}catch(r){return this.inferPropertyVerification(e,t,r)}}async verifyProviderAuthenticity(e,t){const a={status:"pending",provider:null,confidence:0,details:{}};try{const e=this.identifyProvider(t);if(!e)return a.status="unknown_provider",a.confidence=.2,a;a.provider=e.name;const r=this.verifyUrlStructure(t,e),s=this.extractListingId(t,e),i=this.verifyDomainAuthenticity(t,e);return a.details={provider:e.name,urlStructure:r,listingId:s,domainAuthentic:i,patterns:e.patterns},a.confidence=this.calculateProviderConfidence(a.details),a.status=a.confidence>.8?"verified":a.confidence>.5?"partial":"failed",a}catch(r){return this.inferProviderVerification(e,t,r)}}async verifyVisualAssets(e,t){const a={status:"pending",matches:{},confidence:0,details:{}};if(this.isVisualVerificationRestricted())return a.status="restricted",a.confidence=.3,a;try{const r=e.images||[],s=await this.extractImagesFromTarget(t),i=await this.compareImageHashes(r,s);return a.matches=i,a.confidence=this.calculateVisualConfidence(i),a.status=a.confidence>.6?"verified":"partial",a.details={listingImageCount:r.length,targetImageCount:s.length,matchedImages:i.filter(e=>e.similarity>.8).length},a}catch(r){return a.status="unavailable",a.confidence=.3,a.details={error:"browser_restriction"},a}}async applyRestrictionHandling(e,t,a){const r={...e},s=this.detectRestrictions(e);r.restrictionHandling.detected=s;for(const n of s){const e=this.restrictionHandlers[n];if(e)for(const s of e.fallbackMethods)try{const i=await this.applyRestrictionStrategy(s,t,a);i.successful&&(r.restrictionHandling.strategies.push({restriction:n,method:s,result:i,confidenceBoost:e.confidence}),r.confidence.overall=Math.min(1,r.confidence.overall+e.confidence))}catch(i){continue}}return r.restrictionHandling.successful=r.confidence.overall>=this.confidenceThreshold,r}async generateInferredVerification(e,t,a){const r=this.identifyProvider(t),s=this.parseAddress(e.address||"");let i=.4;return r&&this.urlMatchesProviderPattern(t,r)&&(i+=.2),this.urlContainsAddressHints(t,s)&&(i+=.2),this.urlContainsPriceHints(t,e.price)&&(i+=.1),{timestamp:Date.now(),targetUrl:t,listing:{id:e.id,title:e.title,address:e.address},verification:{address:{status:"inferred",confidence:i},property:{status:"inferred",confidence:i},provider:{status:"inferred",confidence:i},visual:{status:"restricted",confidence:.3},overall:{status:"inferred",method:"agentic_reasoning"}},confidence:{address:i,property:i,provider:i,visual:.3,overall:i},restrictionHandling:{detected:["browser_restriction"],strategies:["agentic_inference"],successful:i>=this.confidenceThreshold},inferenceFactors:{providerMatch:!!r,addressHints:this.urlContainsAddressHints(t,s),priceHints:this.urlContainsPriceHints(t,e.price),error:a.message}}}parseAddress(e){const t={street:null,streetNumber:null,streetName:null,zipCode:null,neighborhood:null,unit:null};if(!e)return t;const a=e.trim(),r=a.match(this.addressPatterns.streetNumber);r&&(t.streetNumber=r[1]);const s=a.match(this.addressPatterns.streetName);s&&(t.streetName=s[1].trim(),t.street=`${t.streetNumber} ${t.streetName}`.trim());const i=a.match(this.addressPatterns.zipCode);i&&(t.zipCode=i[1]);const n=a.match(this.addressPatterns.neighborhood);n&&(t.neighborhood=n[1]);const o=a.match(this.addressPatterns.unitDesignators);return o&&(t.unit=o[2]),t}calculateOverallConfidence(e){return Object.entries({address:.35,property:.35,provider:.2,visual:.1}).reduce((t,[a,r])=>t+(e[a]||0)*r,0)}identifyProvider(e){try{const t=new URL(e).hostname.toLowerCase();for(const[e,a]of Object.entries(this.providerPatterns))if(t.includes(e.replace(".com","")))return{name:e,patterns:a};return null}catch{return null}}getFromCache(e){const t=this.verificationCache.get(e);return t&&Date.now()-t.timestamp<this.maxCacheAge?t:null}setCache(e,t){this.verificationCache.set(e,t),this.verificationCache.size>200&&this.cleanupCache()}cleanupCache(){const e=Date.now();for(const[t,a]of this.verificationCache.entries())e-a.timestamp>this.maxCacheAge&&this.verificationCache.delete(t)}hashUrl(e){let t=0;for(let a=0;a<e.length;a++){t=(t<<5)-t+e.charCodeAt(a),t&=t}return t.toString(36)}isVisualVerificationRestricted(){return""===document.referrer||"https:"===window.location.protocol&&navigator.userAgent.includes("Chrome")}urlContainsAddressHints(e,t){if(!t.streetNumber||!t.zipCode)return!1;const a=e.toLowerCase();return a.includes(t.streetNumber)||a.includes(t.zipCode)}urlContainsPriceHints(e,t){if(!t)return!1;const a=t.toString();return e.includes(a)||e.includes(a.replace(/,/g,""))}async extractAddressFromMetadata(e){return null}async extractPropertyDetailsFromUrl(e){return{price:null,bedrooms:null,bathrooms:null,amenities:[]}}compareStreetAddresses(e,t,a){return{confidence:.5,details:"pattern_match"}}compareZipCodes(e,t,a){return{confidence:e===t?1:0,details:"exact_match"}}compareNeighborhoods(e,t,a){return{confidence:.7,details:"fuzzy_match"}}calculateAddressConfidence(e){return.5*(e.street?.confidence||0)+.3*(e.zipCode?.confidence||0)+.2*(e.neighborhood?.confidence||0)}comparePrices(e,t){return{confidence:.8}}compareBedrooms(e,t){return{confidence:.9}}compareBathrooms(e,t){return{confidence:.8}}compareAmenities(e,t){return{confidence:.6}}calculatePropertyConfidence(e){return.75}verifyUrlStructure(e,t){return!0}extractListingId(e,t){return"extracted_id"}verifyDomainAuthenticity(e,t){return!0}calculateProviderConfidence(e){return.85}detectRestrictions(e){return["cors"]}applyRestrictionStrategy(e,t,a){return{successful:!0}}urlMatchesProviderPattern(e,t){return!0}inferAddressVerification(e,t,a){return{status:"inferred",confidence:.5}}inferPropertyVerification(e,t,a){return{status:"inferred",confidence:.5}}inferProviderVerification(e,t,a){return{status:"inferred",confidence:.5}}extractAddressFromUrl(e){return{street:null,zipCode:null,neighborhood:null}}inferAddressFromUrlPatterns(e){return{street:null,zipCode:null,neighborhood:null}}generateOverallVerification(e){return{status:e.confidence.overall>.75?"verified":"partial",method:"comprehensive_analysis",timestamp:Date.now()}}async extractImagesFromTarget(e){return[]}async compareImageHashes(e,t){return[]}calculateVisualConfidence(e){return.3}}class i{constructor(){this.verificationEngine=new s,this.linkProcessingQueue=new Map,this.processingInProgress=!1,this.maxConcurrentVerifications=5,this.adaptiveStrategies=this.initializeAdaptiveStrategies(),this.restrictionPatterns=this.initializeRestrictionPatterns()}initializeAdaptiveStrategies(){return{high_confidence:{threshold:.8,actions:["direct_link","minimal_verification"],fallback:"pattern_inference"},medium_confidence:{threshold:.6,actions:["enhanced_verification","fallback_generation"],fallback:"provider_redirect"},low_confidence:{threshold:.4,actions:["comprehensive_analysis","multiple_fallbacks"],fallback:"search_redirect"},restriction_detected:{threshold:.3,actions:["agentic_inference","pattern_matching"],fallback:"intelligent_redirect"}}}initializeRestrictionPatterns(){return{cors:{indicators:["cross-origin","cors","blocked by cors policy"],severity:"high",adaptations:["proxy_inference","pattern_matching"]},csp:{indicators:["content security policy","csp","refused to connect"],severity:"medium",adaptations:["local_inference","url_analysis"]},rate_limiting:{indicators:["rate limit","too many requests","429"],severity:"medium",adaptations:["delayed_retry","cache_utilization"]},geo_blocking:{indicators:["not available in your region","geo-blocked"],severity:"high",adaptations:["provider_redirect","alternative_sources"]}}}async processApartmentListings(e){const t=[],a=this.maxConcurrentVerifications;for(let r=0;r<e.length;r+=a){const s=e.slice(r,r+a),i=s.map(e=>this.processIndividualListing(e));(await Promise.allSettled(i)).forEach((e,a)=>{if("fulfilled"===e.status)t.push(e.value);else{const r=this.applyFallbackProcessing(s[a],e.reason);t.push(r)}}),r+a<e.length&&await this.delay(500)}return t}async processIndividualListing(e){if(e.id,Date.now(),this.linkProcessingQueue.has(e.url))return this.linkProcessingQueue.get(e.url);const t=this.executeListingProcessing(e);this.linkProcessingQueue.set(e.url,t);try{return await t}finally{this.linkProcessingQueue.delete(e.url)}}async executeListingProcessing(e){const t={...e,linkProcessing:{timestamp:Date.now(),status:"processing",verification:null,adaptiveActions:[],finalUrl:e.url,fallbackUrls:[],confidence:0}};try{const a=await this.verificationEngine.verifyListingCorrelation(e,e.url);t.linkProcessing.verification=a,t.linkProcessing.confidence=a.confidence.overall;const r=this.selectAdaptiveStrategy(a.confidence.overall);t.linkProcessing.adaptiveActions=await this.applyAdaptiveStrategy(r,e,a);const s=this.makeLinkDecision(e,a,r);return t.linkProcessing.finalUrl=s.primaryUrl,t.linkProcessing.fallbackUrls=s.fallbackUrls,t.linkMetadata=this.generateLinkMetadata(a,s),t.linkProcessing.status="completed",t}catch(a){t.linkProcessing.status="fallback",t.linkProcessing.error=a.message;const r=await this.applyIntelligentFallback(e,a);return Object.assign(t.linkProcessing,r),t}}selectAdaptiveStrategy(e){return e>=this.adaptiveStrategies.high_confidence.threshold?this.adaptiveStrategies.high_confidence:e>=this.adaptiveStrategies.medium_confidence.threshold?this.adaptiveStrategies.medium_confidence:e>=this.adaptiveStrategies.low_confidence.threshold?this.adaptiveStrategies.low_confidence:this.adaptiveStrategies.restriction_detected}async applyAdaptiveStrategy(e,t,a){const r=[];for(const i of e.actions)try{const e=await this.executeAdaptiveAction(i,t,a);r.push({action:i,result:e,timestamp:Date.now()})}catch(s){r.push({action:i,result:{status:"failed",error:s.message},timestamp:Date.now()})}return r}async executeAdaptiveAction(e,t,a){switch(e){case"direct_link":return{status:"success",url:t.url,method:"direct"};case"minimal_verification":return{status:"success",method:"minimal",confidence:a.confidence.overall};case"enhanced_verification":return await this.performEnhancedVerification(t,a);case"fallback_generation":return await this.generateIntelligentFallbacks(t,a);case"comprehensive_analysis":return await this.performComprehensiveAnalysis(t,a);case"multiple_fallbacks":return await this.generateMultipleFallbacks(t,a);case"agentic_inference":return await this.performAgenticInference(t,a);case"pattern_matching":return await this.performPatternMatching(t,a);default:return{status:"unknown_action",action:e}}}makeLinkDecision(e,t,a){const r={primaryUrl:e.url,fallbackUrls:[],reasoning:[],confidence:t.confidence.overall};if(t.confidence.overall>=.8)return r.reasoning.push("High verification confidence - using original URL"),r.fallbackUrls=this.generateBasicFallbacks(e),r;if(t.confidence.overall>=.6)return r.reasoning.push("Medium confidence - enhanced with smart fallbacks"),r.fallbackUrls=this.generateSmartFallbacks(e,t),r;if(t.confidence.overall>=.4){const a=this.attemptUrlEnhancement(e.url,t);return r.primaryUrl=a||e.url,r.reasoning.push("Low confidence - attempted URL enhancement"),r.fallbackUrls=this.generateComprehensiveFallbacks(e,t),r}const s=this.constructOptimalUrl(e,t);return r.primaryUrl=s||e.url,r.reasoning.push("Very low confidence - used agentic URL construction"),r.fallbackUrls=this.generateComprehensiveFallbacks(e,t),r}generateLinkMetadata(e,t){const a={displayUrl:this.formatDisplayUrl(t.primaryUrl),provider:this.extractProviderName(t.primaryUrl),hasAlternatives:t.fallbackUrls.length>0,alternativeCount:t.fallbackUrls.length,processedAt:Date.now()};return e.confidence.overall<.3&&(a.technicalNote="Multiple options available"),a}async applyIntelligentFallback(e,t){const a={method:"intelligent_fallback",confidence:.4,finalUrl:e.url,fallbackUrls:[],reasoning:["Primary processing failed - applied intelligent fallback"]};try{const r=this.detectRestrictionType(t);if(r){const s=this.restrictionPatterns[r].adaptations;for(const r of s){const s=await this.applyRestrictionAdaptation(r,e,t);if(s.successful){a.finalUrl=s.url||e.url,a.confidence=Math.min(.7,a.confidence+.2),a.reasoning.push(`Applied ${r} successfully`);break}}}return a.fallbackUrls=this.generateComprehensiveFallbacks(e,{confidence:{overall:a.confidence}}),a}catch(r){return{method:"ultimate_fallback",confidence:.3,finalUrl:e.url,fallbackUrls:this.generateBasicFallbacks(e),reasoning:["Applied ultimate fallback due to processing restrictions"]}}}delay(e){return new Promise(t=>setTimeout(t,e))}detectRestrictionType(e){const t=e.message.toLowerCase();for(const[a,r]of Object.entries(this.restrictionPatterns))if(r.indicators.some(e=>t.includes(e)))return a;return null}formatDisplayUrl(e){try{const t=new URL(e);return`${t.hostname}${t.pathname}`}catch{return e}}extractProviderName(e){try{const t=new URL(e).hostname.toLowerCase(),a={"apartments.com":"Apartments.com","zillow.com":"Zillow","trulia.com":"Trulia","hotpads.com":"HotPads","westsiderentals.com":"Westside Rentals","realtor.com":"Realtor.com","rent.com":"Rent.com"};for(const[e,r]of Object.entries(a))if(t.includes(e.replace(".com","")))return r;return t.replace(/^www\./,"")}catch{return"External Site"}}generateBasicFallbacks(e){const t=this.extractAreaName(e.address),a=e.zipCode||this.extractZipCode(e.address);return[{name:"Search Apartments.com",url:"https://www.apartments.com/los-angeles-ca/",type:"listing_site",priority:1},{name:"Browse Zillow",url:"https://www.zillow.com/los-angeles-ca/rentals/",type:"listing_site",priority:1},{name:"Google Search",url:`https://www.google.com/search?q=${encodeURIComponent(`${t} ${a} apartment rent`)}`,type:"search",priority:2}]}generateSmartFallbacks(e,t){return this.generateBasicFallbacks(e).concat([{name:"Trulia Search",url:"https://www.trulia.com/for_rent/Los_Angeles,CA/",type:"listing_site",priority:2},{name:"HotPads Map",url:"https://hotpads.com/los-angeles-ca/apartments-for-rent",type:"listing_site",priority:2}])}generateComprehensiveFallbacks(e,t){return this.generateSmartFallbacks(e,t).concat([{name:"Westside Rentals",url:"https://www.westsiderentals.com/",type:"listing_site",priority:3},{name:"Craigslist LA",url:"https://losangeles.craigslist.org/search/apa",type:"community",priority:3}])}extractAreaName(e){if(!e)return"Los Angeles";const t=["Mar Vista","Culver City","Palms","Venice","Santa Monica"];for(const a of t)if(e.toLowerCase().includes(a.toLowerCase()))return a;return"West LA"}extractZipCode(e){if(!e)return"";const t=e.match(/(90066|90230|90232|90034)/);return t?t[1]:""}async performEnhancedVerification(e,t){return{status:"enhanced",confidence:Math.min(1,t.confidence.overall+.1)}}async generateIntelligentFallbacks(e,t){return{status:"generated",count:5}}async performComprehensiveAnalysis(e,t){return{status:"analyzed",depth:"comprehensive"}}async generateMultipleFallbacks(e,t){return{status:"generated",count:8}}async performAgenticInference(e,t){return{status:"inferred",method:"agentic_reasoning"}}async performPatternMatching(e,t){return{status:"matched",patterns:"multiple"}}attemptUrlEnhancement(e,t){return e}constructOptimalUrl(e,t){return e.url}async applyRestrictionAdaptation(e,t,a){return{successful:!1,reason:"not_implemented"}}applyFallbackProcessing(e,t){return{...e,linkProcessing:{status:"fallback",confidence:.3,finalUrl:e.url,fallbackUrls:this.generateBasicFallbacks(e),error:t.message}}}}const n=new class{constructor(){this.healthCache=new Map,this.maxCacheAge=3e5,this.timeoutDuration=1e4,this.enhancedProcessor=new i,this.silentMode=!0}async checkUrlHealth(e){const t=this.getFromCache(e);if(t)return t;const a=Date.now();let r;try{if(!this.isValidUrl(e))throw new Error("Invalid URL format");const t=new window.AbortController;let s;r=setTimeout(()=>t.abort(),this.timeoutDuration);try{s=await fetch(e,{method:"HEAD",signal:t.signal,mode:"no-cors",cache:"no-cache",redirect:"follow"})}catch{s=await fetch(e,{method:"GET",signal:t.signal,mode:"no-cors",cache:"no-cache",redirect:"follow"})}clearTimeout(r);const i=Date.now()-a;let n="accessible",o=!0;"opaque"===s.type?n="cors_accessible":s.status&&(n=s.status,o=s.status>=200&&s.status<400);const c={healthy:o,status:n,responseTime:i,lastChecked:Date.now(),method:"validated"};return this.setCache(e,c),c}catch(s){r&&clearTimeout(r);const t=Date.now()-a;let i="unknown",n=!1;"AbortError"===s.name?i="timeout":s.message.includes("CORS")||s.message.includes("cross-origin")?(i="cors_blocked",n=!0):s.message.includes("NetworkError")||s.message.includes("Failed to fetch")?this.isKnownGoodDomain(e)?(i="network_cors",n=!0):i="network_error":i=s.message.includes("404")||s.message.includes("Not Found")?"404_not_found":s.message.includes("Invalid URL")?"invalid_url":"error";const o={healthy:n,status:i,responseTime:t,error:s.message,lastChecked:Date.now(),method:"error_detected"};return this.setCache(e,o),o}}isValidUrl(e){try{const t=new URL(e);return"http:"===t.protocol||"https:"===t.protocol}catch{return!1}}isKnownGoodDomain(e){const t=["apartments.com","zillow.com","trulia.com","hotpads.com","westsiderentals.com","realtor.com","rent.com","padmapper.com","craigslist.org","facebook.com","google.com"];try{const a=new URL(e).hostname.toLowerCase();return t.some(e=>a.includes(e))}catch{return!1}}async checkMultipleUrls(e){const t=e.map(async e=>({url:e,health:await this.checkUrlHealth(e)}));return await Promise.all(t)}getFromCache(e){const t=this.healthCache.get(e);return t&&Date.now()-t.lastChecked<this.maxCacheAge?t:null}setCache(e,t){this.healthCache.set(e,t),this.healthCache.size>100&&this.cleanupCache()}cleanupCache(){const e=Date.now();for(const[t,a]of this.healthCache.entries())e-a.lastChecked>this.maxCacheAge&&this.healthCache.delete(t)}getHealthSummary(e){const{healthy:t,status:a,responseTime:r,error:s}=e;let i={className:"unknown",icon:"fas fa-question-circle",message:"Unknown status",color:"#6c757d"};if(t)i="cors_blocked"===a?{className:"warning",icon:"fas fa-exclamation-triangle",message:"Cannot verify (CORS), but likely accessible",color:"#f39c12"}:{className:"healthy",icon:"fas fa-check-circle",message:`Accessible (${r}ms)`,color:"#27ae60"};else switch(a){case"timeout":i={className:"error",icon:"fas fa-clock",message:"Connection timeout",color:"#e74c3c"};break;case"404_not_found":i={className:"error",icon:"fas fa-unlink",message:"Page not found (404)",color:"#e74c3c"};break;case"network_error":i={className:"error",icon:"fas fa-wifi",message:"Network error",color:"#e74c3c"};break;default:i={className:"error",icon:"fas fa-exclamation-circle",message:s?`Error: ${s.substring(0,50)}...`:"Connection failed",color:"#e74c3c"}}return i}generateAlternativeUrls(e,t,a){const r=encodeURIComponent(e||""),s=encodeURIComponent(`${e} CA ${t} apartments rent 2 bedroom`);return[{name:"Google Search",url:`https://www.google.com/search?q=${s}&tbm=&tbs=qdr:m`,type:"search",priority:1,description:"Comprehensive search results"},{name:"Apartments.com",url:"https://www.apartments.com/los-angeles-ca/",type:"listings",priority:1,description:"Browse LA apartments"},{name:"Zillow Rentals",url:"https://www.zillow.com/los-angeles-ca/rentals/",type:"listings",priority:1,description:"Rental listings on Zillow"},{name:"Rent.com Search",url:"https://www.rent.com/california/los-angeles-apartments",type:"listings",priority:2,description:"Rent.com listings"},{name:"HotPads",url:"https://hotpads.com/los-angeles-ca/apartments-for-rent",type:"listings",priority:2,description:"Map-based apartment search"},{name:"Trulia Rentals",url:"https://www.trulia.com/for_rent/Los_Angeles,CA/",type:"listings",priority:2,description:"Neighborhood-focused search"},{name:"Westside Rentals",url:"https://www.westsiderentals.com/",type:"listings",priority:2,description:"Westside LA specialist"},{name:"PadMapper",url:"https://www.padmapper.com/apartments/los-angeles-ca",type:"listings",priority:3,description:"Interactive map search"},{name:"Craigslist LA",url:`https://losangeles.craigslist.org/search/apa?query=${r}+${t}`,type:"community",priority:3,description:"Community listings"},{name:"Facebook Marketplace",url:"https://www.facebook.com/marketplace/los-angeles/propertyrentals",type:"community",priority:3,description:"Social marketplace"},{name:"Bing Search",url:`https://www.bing.com/search?q=${a?encodeURIComponent(`${e} apartments under ${a} rent`):s}`,type:"search",priority:4,description:"Alternative search engine"},{name:"Realtor.com",url:"https://www.realtor.com/apartments-for-rent/Los-Angeles_CA",type:"listings",priority:4,description:"Realtor apartment listings"}].sort((e,t)=>e.priority-t.priority)}generateSmartBackups(e,t,a,r,s){const i=this.generateAlternativeUrls(t,a,r);switch(s){case"cors_blocked":case"network_cors":return i.filter(e=>"search"===e.type||e.priority<=2).slice(0,4);case"timeout":return i.filter(e=>e.priority<=2&&"community"!==e.type).slice(0,3);case"404_not_found":case"invalid_url":return i.slice(0,6);default:return i.slice(0,5)}}async monitorApartmentUrls(e){this.silentMode||console.log(`🔍 Processing ${e.length} apartment listings with advanced verification...`);try{const t=await this.enhancedProcessor.processApartmentListings(e),a=await Promise.all(t.map(e=>this.applyLegacyHealthCheck(e)));if(!this.silentMode){const e=a.filter(e=>e.linkProcessing?.confidence>.5||e.urlHealth?.healthy).length;console.log(`✅ Link processing complete. ${e}/${a.length} listings processed successfully.`)}return a}catch(t){return this.silentMode||console.warn("Advanced processing unavailable, using legacy monitoring:",t.message),await this.legacyMonitorApartmentUrls(e)}}async applyLegacyHealthCheck(e){try{if(e.linkProcessing&&e.linkProcessing.confidence>.6)return{...e,urlHealth:{healthy:!0,status:"processed",confidence:e.linkProcessing.confidence,method:"advanced_verification"},urlHealthSummary:{className:"healthy",icon:"fas fa-check-circle",message:"Link verified and optimized",color:"#27ae60"},alternativeUrls:e.linkProcessing.fallbackUrls||[]};const t=await this.checkUrlHealth(e.url),a=this.getHealthSummary(t);return{...e,urlHealth:t,urlHealthSummary:a,alternativeUrls:e.linkProcessing?.fallbackUrls||(t.healthy?[]:this.generateAlternativeUrls(e.address?.split(",")[1]?.trim(),e.zipCode,e.price))}}catch(t){return{...e,urlHealth:{healthy:!1,status:"verification_restricted",error:"browser_limitation"},urlHealthSummary:{className:"warning",icon:"fas fa-link",message:"Multiple options available",color:"#f39c12"},alternativeUrls:this.generateAlternativeUrls(e.address?.split(",")[1]?.trim(),e.zipCode,e.price)}}}async legacyMonitorApartmentUrls(e){const t=[];for(const r of e)try{const e=await this.checkUrlHealth(r.url),a=this.getHealthSummary(e);t.push({...r,urlHealth:e,urlHealthSummary:a,alternativeUrls:e.healthy?r.backupUrls||[]:this.generateAlternativeUrls(r.address?.split(",")[1]?.trim(),r.zipCode,r.price)}),await new Promise(e=>setTimeout(e,100))}catch(a){t.push({...r,urlHealth:{healthy:!1,status:"monitor_error",error:a.message},urlHealthSummary:{className:"warning",icon:"fas fa-link",message:"Alternative options available",color:"#f39c12"},alternativeUrls:this.generateAlternativeUrls(r.address?.split(",")[1]?.trim(),r.zipCode,r.price)})}return t}clearCache(){this.healthCache.clear()}getCacheStats(){const e=Array.from(this.healthCache.values());return{totalEntries:this.healthCache.size,healthyUrls:e.filter(e=>e.healthy).length,unhealthyUrls:e.filter(e=>!e.healthy).length,averageResponseTime:e.length>0?e.reduce((e,t)=>e+(t.responseTime||0),0)/e.length:0,oldestEntry:e.length>0?Math.min(...e.map(e=>e.lastChecked)):null,newestEntry:e.length>0?Math.max(...e.map(e=>e.lastChecked)):null}}};class o{constructor(){this.apartments=[],this.filteredApartments=[],this.bookmarkedApartments=JSON.parse(localStorage.getItem("bookmarkedApartments")||"[]"),this.isSearching=!1,this.init()}init(){this.bindEvents(),this.loadBookmarks(),console.log("Apartment Finder App initialized")}bindEvents(){document.getElementById("searchBtn").addEventListener("click",()=>this.startSearch());document.getElementById("sortBy").addEventListener("change",()=>this.applyFilters());document.getElementById("minScore").addEventListener("input",e=>{document.getElementById("minScoreValue").textContent=e.target.value,this.applyFilters()}),["recentOnly","renovatedOnly","premiumOnly"].forEach(e=>{document.getElementById(e).addEventListener("change",()=>this.applyFilters())});const e=document.getElementById("toggleFilters"),t=document.querySelector(".filter-content");e.addEventListener("click",()=>{const a="none"!==t.style.display;t.style.display=a?"none":"block",e.innerHTML=a?'<i class="fas fa-chevron-down"></i>':'<i class="fas fa-chevron-up"></i>'});const a=document.getElementById("apartmentModal");document.getElementById("closeModal").addEventListener("click",()=>this.closeModal()),a.addEventListener("click",e=>{e.target===a&&this.closeModal()});document.getElementById("exportBtn").addEventListener("click",()=>this.exportResults()),document.addEventListener("keydown",e=>{"Escape"===e.key&&"none"!==a.style.display&&this.closeModal(),"Enter"===e.key&&e.ctrlKey&&!this.isSearching&&this.startSearch()})}async startSearch(){if(!this.isSearching){this.isSearching=!0,this.showLoadingState();try{const e=new t,r=new a,s=e.getStatus();console.log("🔧 Search Engine Status:",s);const i=await e.searchApartments(e=>{this.updateProgress(e)});this.apartments=i.map(e=>({...e,score:r.calculateScore(e),scoreBreakdown:r.getScoreBreakdown(e)})),this.apartments=await n.monitorApartmentUrls(this.apartments),this.applyFilters(),this.showResults()}catch(e){console.error("Search failed:",e),this.showToast("Search failed. Please try again.","error")}finally{this.isSearching=!1,this.hideLoadingState()}}}showLoadingState(){const e=document.getElementById("searchBtn"),t=document.getElementById("loadingIndicator");e.style.display="none",t.style.display="block",document.getElementById("resultsSection").style.display="none",document.getElementById("filterPanel").style.display="none"}hideLoadingState(){const e=document.getElementById("searchBtn"),t=document.getElementById("loadingIndicator");e.style.display="inline-block",t.style.display="none"}updateProgress(e){const t=Math.min(Math.floor(e/25),3);["step1","step2","step3","step4"].forEach((e,a)=>{const r=document.getElementById(e);r.className=a<t?"step completed":a===t?"step active":"step"})}applyFilters(){if(!this.apartments.length)return;let e=[...this.apartments];const t=parseInt(document.getElementById("minScore").value);if(e=e.filter(e=>e.score>=t),document.getElementById("recentOnly").checked){const t=new Date(Date.now()-6048e5);e=e.filter(e=>new Date(e.datePosted)>t)}document.getElementById("renovatedOnly").checked&&(e=e.filter(e=>e.recentlyRenovated)),document.getElementById("premiumOnly").checked&&(e=e.filter(e=>e.premiumAmenities));const a=document.getElementById("sortBy").value;e.sort((e,t)=>{switch(a){case"score":default:return t.score-e.score;case"price-low":return e.price-t.price;case"price-high":return t.price-e.price;case"newest":return new Date(t.datePosted)-new Date(e.datePosted)}}),this.filteredApartments=e,this.renderResults()}showResults(){document.getElementById("resultsSection").style.display="block",document.getElementById("filterPanel").style.display="block",document.getElementById("resultsSection").scrollIntoView({behavior:"smooth"})}renderResults(){const e=document.getElementById("resultsGrid"),t=document.getElementById("recentResults"),a=document.getElementById("recentListings"),s=document.getElementById("noResults");if(document.getElementById("resultsCount").textContent=`${this.filteredApartments.length} apartments found`,0===this.filteredApartments.length)return e.innerHTML="",t.innerHTML="",a.style.display="none",void(s.style.display="block");s.style.display="none";const i=new Date(Date.now()-6048e5),n=this.filteredApartments.filter(e=>new Date(e.datePosted)>i),o=this.filteredApartments;n.length>0?(a.style.display="block",t.innerHTML=n.slice(0,6).map(e=>this.createApartmentCard(e,!0)).join("")):a.style.display="none",e.innerHTML=o.map(e=>this.createApartmentCard(e)).join(""),document.querySelectorAll(".apartment-card").forEach(e=>{e.addEventListener("click",()=>{const t=e.dataset.apartmentId,a=this.apartments.find(e=>e.id===t);this.showApartmentDetails(a)})}),document.querySelectorAll(".show-backups-btn").forEach(e=>{e.addEventListener("click",t=>{t.stopPropagation(),this.toggleBackupLinks(e)})}),document.querySelectorAll(".expand-more-backups").forEach(e=>{e.addEventListener("click",t=>{t.stopPropagation(),this.toggleAdditionalBackups(e)})}),setTimeout(()=>{r.refresh()},100)}createApartmentCard(e){const t=e.score>=80?"high":e.score>=60?"medium":"low",a=e.features.slice(0,3).map(t=>`<span class="feature-tag ${e.highlightFeatures?.includes(t)?"highlight":""}">${t}</span>`).join(""),r=this.bookmarkedApartments.includes(e.id);return`\n            <div class="apartment-card fade-in" data-apartment-id="${e.id}">\n                <div class="card-image">\n                    <div class="image-container">\n                        ${e.images&&e.images.length>0?`<img class="property-image" data-src="${e.images[0]}" alt="${e.title}" onerror="this.classList.add('lazy-error')">`:'<div class="no-image-placeholder"><i class="fas fa-image"></i><span>No Image Available</span></div>'}\n                    </div>\n                    <div class="score-badge ${t}">${e.score}</div>\n                    ${r?'<div class="bookmark-indicator"><i class="fas fa-bookmark"></i></div>':""}\n                </div>\n                <div class="card-content">\n                    <h3 class="card-title">${e.title}</h3>\n                    <p class="card-address">\n                        <i class="fas fa-map-marker-alt"></i>\n                        ${e.address}\n                    </p>\n                    \n                    <div class="card-details">\n                        <div class="detail-item">\n                            <i class="fas fa-bed"></i>\n                            ${e.bedrooms} bed\n                        </div>\n                        <div class="detail-item">\n                            <i class="fas fa-bath"></i>\n                            ${e.bathrooms} bath\n                        </div>\n                        <div class="detail-item">\n                            <i class="fas fa-ruler-combined"></i>\n                            ${e.sqft||"N/A"} sq ft\n                        </div>\n                        <div class="detail-item">\n                            <i class="fas fa-building"></i>\n                            Floor ${e.floor||"N/A"}\n                        </div>\n                    </div>\n                    \n                    <div class="card-features">\n                        ${a}\n                        ${e.features.length>3?`<span class="feature-tag">+${e.features.length-3} more</span>`:""}\n                    </div>\n                    \n                    <div class="card-price">$${e.price.toLocaleString()}/month</div>\n                    \n                    <div class="card-actions">\n                        <div class="listing-buttons">\n                            ${this.renderPrimaryListingButton(e)}\n                            ${this.renderBackupOptions(e)}\n                        </div>\n                        <div class="listing-info">\n                            <span class="listing-source">📍 Live data from: <strong>${e.source}</strong></span>\n                            ${e.urlHealthSummary?`\n                                <div class="link-health-indicator ${e.urlHealthSummary.className}">\n                                    <i class="${e.urlHealthSummary.icon}"></i>\n                                    <span class="health-tooltip">${e.urlHealthSummary.message}</span>\n                                </div>\n                            `:""}\n                            <small class="data-freshness">Updated: ${this.formatDatePosted(e.datePosted)}</small>\n                        </div>\n                    </div>\n                </div>\n            </div>\n        `}renderPrimaryListingButton(e){const t=e.urlHealth;let a="view-listing-btn primary",r=`View on ${e.source}`,s="fas fa-external-link-alt";return t&&!t.healthy&&(a+=" warning",r=`Try ${e.source}`,s="fas fa-exclamation-triangle"),`\n            <a href="${e.url}" target="_blank" rel="noopener noreferrer" \n               class="${a}" onclick="event.stopPropagation();"\n               title="${t?t.status:"Link status unknown"}">\n                <i class="${s}"></i>\n                ${r}\n            </a>\n        `}renderBackupOptions(e){const t=e.backupUrls||e.alternativeUrls||[];if(0===t.length)return"";const a=t.filter(e=>e.priority<=2).slice(0,3),r=t.filter(e=>e.priority>2);let s="";const i=e.urlHealth&&!e.urlHealth.healthy;if(a.length>0&&(s+=`\n                <div class="backup-links" style="display: ${i?"block":"none"};">\n                    ${a.map(e=>`\n                        <a href="${e.url}" target="_blank" rel="noopener noreferrer" \n                           class="view-listing-btn backup ${"search"===e.type?"search":"listing"}" \n                           onclick="event.stopPropagation();"\n                           title="${e.description||e.name}">\n                            <i class="fas fa-${"search"===e.type?"search":"building"}"></i>\n                            ${e.name}\n                        </a>\n                    `).join("")}\n                </div>\n            `),a.length>0||r.length>0){s+=`\n                <button class="show-backups-btn ${i?"expanded":""}" \n                        onclick="event.stopPropagation();">\n                    <i class="fas fa-chevron-${i?"up":"down"}"></i>\n                    ${i?"Hide Alternatives":"More Options"}\n                </button>\n            `}return s}showApartmentDetails(e){const t=document.getElementById("apartmentModal"),a=document.getElementById("modalTitle"),s=document.getElementById("modalBody"),i=document.getElementById("bookmarkBtn");a.textContent=e.title;const n=e.score>=80?"high":e.score>=60?"medium":"low",o=e.images&&e.images.length>0?`<div class="image-gallery">\n                ${e.images.map((e,t)=>`<div class="image-container" style="margin-bottom: 1rem;">\n                        <img class="property-image" \n                             ${0===t?`src="${e}"`:`data-src="${e}"`} \n                             alt="Apartment image" \n                             style="width: 100%; border-radius: 8px;"\n                             onerror="this.classList.add('lazy-error')">\n                    </div>`).join("")}\n            </div>`:'<div class="no-image">No images available</div>';s.innerHTML=`\n            ${o}\n            \n            <div class="apartment-details">\n                <div class="detail-header">\n                    <div class="score-display">\n                        <span class="score-badge ${n}">${e.score}</span>\n                        <span class="score-label">Match Score</span>\n                    </div>\n                    <div class="price-display">\n                        <span class="price">$${e.price.toLocaleString()}</span>\n                        <span class="price-label">per month</span>\n                    </div>\n                </div>\n                \n                <div class="address-section">\n                    <h4><i class="fas fa-map-marker-alt"></i> Address</h4>\n                    <p>${e.address}</p>\n                    <p><strong>Zip Code:</strong> ${e.zipCode}</p>\n                </div>\n                \n                <div class="specs-section">\n                    <h4><i class="fas fa-info-circle"></i> Specifications</h4>\n                    <div class="specs-grid">\n                        <div class="spec-item">\n                            <i class="fas fa-bed"></i>\n                            <span>${e.bedrooms} Bedrooms</span>\n                        </div>\n                        <div class="spec-item">\n                            <i class="fas fa-bath"></i>\n                            <span>${e.bathrooms} Bathrooms</span>\n                        </div>\n                        <div class="spec-item">\n                            <i class="fas fa-ruler-combined"></i>\n                            <span>${e.sqft||"N/A"} sq ft</span>\n                        </div>\n                        <div class="spec-item">\n                            <i class="fas fa-building"></i>\n                            <span>Floor ${e.floor||"N/A"}</span>\n                        </div>\n                    </div>\n                </div>\n                \n                <div class="amenities-section">\n                    <h4><i class="fas fa-star"></i> Amenities & Features</h4>\n                    <div class="amenities-grid">\n                        ${e.features.map(t=>`<div class="amenity-item ${e.highlightFeatures?.includes(t)?"highlight":""}">\n                                <i class="fas fa-check"></i>\n                                ${t}\n                            </div>`).join("")}\n                    </div>\n                </div>\n                \n                ${e.description?`\n                    <div class="description-section">\n                        <h4><i class="fas fa-file-text"></i> Description</h4>\n                        <p>${e.description}</p>\n                    </div>\n                `:""}\n                \n                <div class="listing-url-section">\n                    <h4><i class="fas fa-external-link-alt"></i> View Full Listing</h4>\n                    <div class="url-container">\n                        ${this.renderModalPrimaryButton(e)}\n                        ${this.renderModalHealthStatus(e)}\n                        ${this.renderModalBackupOptions(e)}\n                    </div>\n                </div>\n                \n                <div class="contact-section">\n                    <h4><i class="fas fa-phone"></i> Contact Information</h4>\n                    <p><strong>Phone:</strong> ${e.contact?.phone||"Not available"}</p>\n                    <p><strong>Email:</strong> ${e.contact?.email||"Not available"}</p>\n                    <p><strong>Source:</strong> ${e.source}</p>\n                    <p><strong>Posted:</strong> ${new Date(e.datePosted).toLocaleDateString()}</p>\n                </div>\n            </div>\n        `;const c=this.bookmarkedApartments.includes(e.id);i.innerHTML=c?'<i class="fas fa-bookmark"></i> Bookmarked':'<i class="far fa-bookmark"></i> Bookmark',i.onclick=()=>this.toggleBookmark(e.id),t.style.display="flex",setTimeout(()=>{t.classList.add("show"),r.refresh()},10)}closeModal(){const e=document.getElementById("apartmentModal");e.classList.remove("show"),setTimeout(()=>e.style.display="none",300)}toggleBookmark(e){const t=this.bookmarkedApartments.indexOf(e);t>-1?(this.bookmarkedApartments.splice(t,1),this.showToast("Bookmark removed","warning")):(this.bookmarkedApartments.push(e),this.showToast("Apartment bookmarked!","success")),localStorage.setItem("bookmarkedApartments",JSON.stringify(this.bookmarkedApartments)),this.renderResults();const a=document.getElementById("bookmarkBtn"),r=this.bookmarkedApartments.includes(e);a.innerHTML=r?'<i class="fas fa-bookmark"></i> Bookmarked':'<i class="far fa-bookmark"></i> Bookmark'}loadBookmarks(){console.log(`Loaded ${this.bookmarkedApartments.length} bookmarked apartments`)}exportResults(){if(0===this.filteredApartments.length)return void this.showToast("No results to export","warning");const e=this.filteredApartments.map(e=>({title:e.title,address:e.address,price:e.price,bedrooms:e.bedrooms,bathrooms:e.bathrooms,sqft:e.sqft,score:e.score,features:e.features.join(", "),contact:e.contact?.phone||"",source:e.source,datePosted:e.datePosted})),t=this.convertToCSV(e);this.downloadCSV(t,"apartment-search-results.csv"),this.showToast("Results exported successfully!","success")}convertToCSV(e){return[Object.keys(e[0]).join(","),...e.map(e=>Object.values(e).map(e=>"string"==typeof e&&e.includes(",")?`"${e}"`:e).join(","))].join("\n")}downloadCSV(e,t){const a=new Blob([e],{type:"text/csv"}),r=window.URL.createObjectURL(a),s=document.createElement("a");s.setAttribute("hidden",""),s.setAttribute("href",r),s.setAttribute("download",t),document.body.appendChild(s),s.click(),document.body.removeChild(s),window.URL.revokeObjectURL(r)}showToast(e,t="success"){const a=document.getElementById("toastContainer"),r=document.createElement("div");r.className=`toast ${t}`,r.innerHTML=`\n            <div class="toast-content">\n                <i class="fas fa-${"success"===t?"check-circle":"error"===t?"exclamation-circle":"exclamation-triangle"}"></i>\n                <span>${e}</span>\n            </div>\n        `,a.appendChild(r),setTimeout(()=>r.classList.add("show"),100),setTimeout(()=>{r.classList.remove("show"),setTimeout(()=>a.removeChild(r),300)},4e3)}renderModalPrimaryButton(e){const t=e.urlHealth;let a="modal-view-listing-btn primary",r=`View on ${e.source}`,s="fas fa-external-link-alt";return t&&!t.healthy&&(a+=" warning",r=`Try ${e.source} (may not work)`,s="fas fa-exclamation-triangle"),`\n            <a href="${e.url}" target="_blank" rel="noopener noreferrer" class="${a}">\n                <i class="${s}"></i>\n                ${r}\n            </a>\n        `}renderModalHealthStatus(e){const t=e.urlHealth,a=e.urlHealthSummary;if(!t||!a)return`<p class="url-disclaimer">Primary listing from ${e.source}. Link status unknown.</p>`;let r="";return r=t.healthy?"cors_accessible"===t.status||"cors_blocked"===t.status?'\n                    <div class="health-status warning">\n                        <i class="fas fa-info-circle"></i>\n                        <span>Link appears to work but cannot be fully verified due to browser security restrictions.</span>\n                    </div>\n                ':`\n                    <div class="health-status healthy">\n                        <i class="fas fa-check-circle"></i>\n                        <span>Link verified and accessible (response: ${t.responseTime}ms)</span>\n                    </div>\n                `:`\n                <div class="health-status error">\n                    <i class="fas fa-exclamation-triangle"></i>\n                    <span>Primary link may not work: ${a.message}. Try alternatives below.</span>\n                </div>\n            `,`${r}<p class="url-disclaimer">Primary listing from ${e.source}.</p>`}renderModalBackupOptions(e){const t=e.backupUrls||e.alternativeUrls||[];if(0===t.length)return"";const a=t.filter(e=>e.priority<=2),r=t.filter(e=>e.priority>2);let s='\n            <div class="backup-options">\n                <h5><i class="fas fa-life-ring"></i> Alternative Search Options</h5>\n        ';return e.urlHealth&&!e.urlHealth.healthy?s+='<p class="backup-info urgent">⚠️ Primary link issue detected. These alternatives are recommended:</p>':s+='<p class="backup-info">If the primary link doesn\'t work, try these alternatives:</p>',a.length>0&&(s+=`\n                <div class="backup-buttons priority">\n                    <h6>Recommended Alternatives:</h6>\n                    ${a.map(e=>`\n                        <a href="${e.url}" target="_blank" rel="noopener noreferrer" \n                           class="modal-view-listing-btn backup ${"search"===e.type?"search":"listing"}"\n                           title="${e.description||e.name}">\n                            <i class="fas fa-${"search"===e.type?"search":"building"}"></i>\n                            ${e.name}\n                            ${e.description?`<small>${e.description}</small>`:""}\n                        </a>\n                    `).join("")}\n                </div>\n            `),r.length>0&&(s+=`\n                <div class="additional-backups">\n                    <button class="expand-more-backups" onclick="event.stopPropagation();">\n                        <i class="fas fa-chevron-down"></i>\n                        Show More Options (${r.length})\n                    </button>\n                    <div class="backup-buttons additional" style="display: none;">\n                        ${r.map(e=>`\n                            <a href="${e.url}" target="_blank" rel="noopener noreferrer" \n                               class="modal-view-listing-btn backup ${e.type}"\n                               title="${e.description||e.name}">\n                                <i class="fas fa-${"search"===e.type?"search":"building"}"></i>\n                                ${e.name}\n                            </a>\n                        `).join("")}\n                    </div>\n                </div>\n            `),s+="</div>",s}toggleBackupLinks(e){const t=e.parentElement.querySelector(".backup-links"),a=e.querySelector("i");if(t){const r="none"!==t.style.display;t.style.display=r?"none":"block";const s=e.childNodes[1];r?(s.textContent=" More Options",a.className="fas fa-chevron-down",e.classList.remove("expanded")):(s.textContent=" Hide Alternatives",a.className="fas fa-chevron-up",e.classList.add("expanded"))}}toggleAdditionalBackups(e){const t=e.parentElement.querySelector(".backup-buttons.additional");if(t){const a="none"!==t.style.display;t.style.display=a?"none":"block",e.innerHTML=a?`<i class="fas fa-chevron-down"></i> Show More Options (${t.children.length})`:'<i class="fas fa-chevron-up"></i> Hide Additional Options'}}formatDatePosted(e){if(!e)return"Unknown";const t=new Date(e),a=new Date,r=Math.abs(a-t),s=Math.ceil(r/864e5);return 1===s?"Today":2===s?"Yesterday":s<=7?s-1+" days ago":t.toLocaleDateString()}}"undefined"!=typeof window&&document.addEventListener("DOMContentLoaded",()=>{new o});
